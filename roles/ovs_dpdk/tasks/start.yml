---

- name: Configure HugePages to {{ ovs_dpdk.dpdk.hugepages.total_size }} with {{ ovs_dpdk.dpdk.hugepages.page_size }} page size
  shell: |
    /tmp/{{ project.name }}/dpdk/usertools/dpdk-hugepages.py \
    -p {{ ovs_dpdk.dpdk.hugepages.page_size }} \
    --setup {{ ovs_dpdk.dpdk.hugepages.total_size }}
  become: true

- name: Variable to update PATH with GVS script and DB_SOCK with GVS DB scoket file
  set_fact:
    ovs_environment:
      PATH: /usr/local/share/openvswitch/scripts:{{ ansible_env.PATH }}
      DB_SOCK: /usr/local/var/run/openvswitch/db.sock

- name: Stop running instance of GVS and delete existing bridges
  shell: |
    ovs-vsctl --all destroy Open_vSwitch
    ovs-ctl --delete-bridges stop
  environment: "{{ ovs_environment }}"
  ignore_errors: true
  become: true

- name: Delete existing vswitchd log file
  file: 
    name: "{{ ovs_dpdk.ovs.vswitchd.log_file }}"
    state: absent
  ignore_errors: true
  become: true

- name: Set network interfaces down before binding to DPDK
  shell: |
    ip link set {{ item.interface_name }} down
  loop: "{{ ovs_dpdk.ovs.bridge.ports }}"
  become: true

- name: Add the uio_pci_generic module for DPDK
  community.general.modprobe:
    name: uio_pci_generic
    state: present
  become: true

- name: Bind ports to DPDK
  shell: |
    python3 /tmp/{{ project.name }}/dpdk/usertools/dpdk-devbind.py -b {{ item.driver.dpdk }} {{ item.pcie_id }}
  loop: "{{ ovs_dpdk.ovs.bridge.ports }}"
  become: true

- name: Configure a bridge with Open vSwitch
  environment: "{{ ovs_environment }}"
  become: true
  block:
    - name: Start OVSDB and configure other_config params
      shell: |
        ovs-ctl --no-ovs-vswitchd --system-id=random --delete-bridges start
        ovs-vsctl --no-wait \
          set Open_vSwitch . other_config:dpdk-init=true -- \
          set Open_vSwitch . other_config:max-idle={{ ovs_dpdk.ovs.params.max_idle }} -- \
          set Open_vSwitch . other_config:hw-offload={{ ovs_dpdk.ovs.params.hw_offload }}  -- \
          set Open_vSwitch . other_config:n-handler-threads={{ ovs_dpdk.ovs.params.dpdk.n_handler_threads }}  -- \
          set Open_vSwitch . other_config:n-revalidator-threads={{ ovs_dpdk.ovs.params.dpdk.n_revalidator_threads }} -- \
          set Open_vSwitch . other_config:pmd-perf-metrics=true
    
    - name: Start GVS vswitchd
      shell: |
        ovs-ctl --no-ovsdb-server --db-sock="$DB_SOCK" start

    - name: Add bridge {{ ovs_dpdk.ovs.bridge.name }} to GVS
      shell: |
        ovs-vsctl del-br {{ ovs_dpdk.ovs.bridge.name }}
        ovs-vsctl add-br {{ ovs_dpdk.ovs.bridge.name }} -- set bridge {{ ovs_dpdk.ovs.bridge.name }} datapath_type=netdev fail-mode=secure

    - name: Add ports to {{ ovs_dpdk.ovs.bridge.name }} 
      shell: |
        ovs-vsctl add-port {{ ovs_dpdk.ovs.bridge.name }} {{ item.bridge_port_name }} -- \
          set Interface {{ item.bridge_port_name }} type=dpdk options:dpdk-devargs={{ item.pcie_id }} -- \
          set Interface {{ item.bridge_port_name }} options:n_rxq={{ ovs_dpdk.ovs.params.dpdk.n_rxq }}
      loop: "{{ ovs_dpdk.ovs.bridge.ports }}"

    - name: Clear pmd statistics
      shell: |
        ovs-appctl dpif-netdev/pmd-stats-clear